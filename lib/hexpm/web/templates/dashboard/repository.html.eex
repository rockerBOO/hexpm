<div class="row">
  <div class="col-md-3">
    <%= render "_sidebar.html", assigns %>
  </div>

  <div class="col-md-9 repository members">
    <div class="panel panel-default">
      <div class="panel-heading">Members</div>
      <div class="panel-body">
        Here you control your organization members and their roles. Mouse-over the role for more details.
      </div>
      <ul class="list-group clearfix">
        <%= for repository_user <- @repository.repository_users do %>
          <li class="list-group-item clearfix">
            <img src="<%= gravatar_url(User.email(repository_user.user, :public), :small) %>" class="member-avatar">
            <a class="member-username" href="<%= Routes.user_path(Endpoint, :show, repository_user.user) %>"><%= repository_user.user.username %></a>
            <div style="float: right">
              <div class="dropdown role-dropdown">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                  <%= repository_role(repository_user.role) %>
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right">
                  <%= for {name, id, title} <- repository_roles() do %>
                    <li>
                      <%= form_tag Routes.dashboard_path(Endpoint, :update_repository, @repository), class: "change-role" do %>
                        <input type="hidden" name="action" value="change_role">
                        <input type="hidden" name="repository_user[username]" value="<%= repository_user.user.username %>">
                        <input type="hidden" name="repository_user[role]" value="<%= id %>">
                        <button type="submit" class="btn btn-link" title="<%= title %>"><%= name %></button>
                      <% end %>
                    </li>
                  <% end %>
                </ul>
                  <%= form_tag Routes.dashboard_path(Endpoint, :update_repository, @repository), class: "remove-role" do %>
                    <input type="hidden" name="action" value="remove_member">
                    <input type="hidden" name="repository_user[username]" value="<%= repository_user.user.username %>">
                    <%= submit "Remove", class: "btn btn-danger", disabled: repository_user.user.id == @current_user.id %>
                  <% end %>
              </div>
            </div>
          </li>
        <% end %>
        <li class="list-group-item clearfix">
          <%= form_for @add_member_changeset, Routes.dashboard_path(Endpoint, :update_repository, @repository), [method: :post, class: "form-inline"], fn f -> %>
            <input type="hidden" name="action" value="add_member">
            <div class="form-group">
              <%= text_input f, :username, class: "form-control", style: "width: 250px", placeholder: "Username or email address", required: true %>
              <%= error_tag f, :username %>
            </div>
            <div class="form-group">
              <%= select f, :role, repository_roles_selector(), style: "width: 80px" %>
              <%= error_tag f, :role %>
            </div>
            <button type="submit" class="btn btn-primary">Add member</button>
          <% end %>
        </li>
      </ul>
    </div>
  </div>

  <div class="col-md-9 repository">
    <div class="panel panel-default">
      <div class="panel-heading">Packages</div>
      <div class="panel-body">
        <%= if @repository.packages == [] do %>
          No packages in organization repository.
        <% else %>
          <ul class="repository-package-list">
            <%= for package <- @repository.packages do %>
              <li>
                <a href="<%= path_for_package(@repository.name, package.name) %>"><%= package.name %></a>
                <%= package.latest_version %>
              </li>
            <% end %>
          </ul>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-9 repository">
    <div class="panel panel-default">
      <div class="panel-heading">Billing</div>
      <div class="panel-body">
        <%= if @subscription do %>
          <dl>
            <dt>Plan</dt>
            <dd>Hex.pm Organization ($8.00 per user / month)</dd>
            <dt>Payment</dt>
            <dd><%= payment_card(@card) %></dd>
            <dt>Next invoice</dt>
            <%= if @subscription["cancel_at_period_end"] do %>
              <dd>Subscription ends at <%= payment_date(@subscription["current_period_end"]) %></dd>
            <% else %>
              <dd><%= payment_date(@subscription["current_period_end"]) %></dd>
            <% end %>
            <dt>Status</dt>
            <dd><%= subscription_status(@subscription) %></dd>
          </dl>

          <%= raw(@checkout_html) %>
          <%= form_tag(Routes.dashboard_path(Endpoint, :cancel_billing, @repository), class: "cancel-billing") do %>
            <%= submit "Cancel", class: "btn btn-danger", disabled: !@subscription || @subscription["cancel_at_period_end"] %>
          <% end %>
        <% else %>
          Subscription is not active. Organization will be disabled until a payment method has been added.<br><br>
          <%= raw(@checkout_html) %>
        <% end %>
      </div>

      <div class="panel-body-part">
        <h4>Billing information</h4>
        <div>
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="<%= if show_person?(@person, @errors) do %>active<% end %>"><a href="#person" aria-controls="person" role="tab" data-toggle="tab">Person</a></li>
            <li role="presentation" class="<%= if show_company?(@company, @errors) do %>active<% end %>"><a href="#company" aria-controls="company" role="tab" data-toggle="tab">Company</a></li>
          </ul>

          <div class="tab-content">
            <div role="tabpanel" class="tab-pane <%= if show_person?(@person, @errors) do %>active<% end %>" id="person">
              <%= form_tag(Routes.dashboard_path(Endpoint, :update_billing, @repository)) do %>
                <div class="form-group">
                  <label for="billing_email">Billing email</label>
                  <select id="billing_email" name="email" class="form-control" required>
                    <%= for email <- billing_emails(@current_user, @billing_email) do %>
                      <option value="<%= email %>" <%= if email == (@params["billing_email"] || @billing_email) do %>selected<% end %>><%= email %></option>
                    <% end %>
                  </select>
                </div>
                <div class="form-group">
                  <label for="person_country">Country</label>
                  <select id="person_country" name="person[country]" class="form-control" required>
                    <%= for {code, country} <- countries() do %>
                      <option value="<%= code %>" <%= if code == (@params["person"]["country"] || @person["country"]) do %>selected<% end %>><%= country %></option>
                    <% end %>
                  </select>
                </div>
                <%= submit "Save", class: "btn btn-primary" %>
              <% end %>
            </div>
            <div role="tabpanel" class="tab-pane <%= if show_company?(@company, @errors) do %>active<% end %>" id="company">
              <%= form_tag(Routes.dashboard_path(Endpoint, :update_billing, @repository)) do %>
                <div class="form-group">
                  <label for="billing_email">Billing email</label>
                  <select id="billing_email" name="email" class="form-control" required>
                    <%= for email <- billing_emails(@current_user, @billing_email) do %>
                      <option value="<%= email %>" <%= if email == (@params["billing_email"] || @billing_email) do %>selected<% end %>><%= email %></option>
                    <% end %>
                  </select>
                </div>
                <div class="form-group">
                  <label for="company_name">Company name</label>
                  <input id="company_name" name="company[name]" class="form-control" type="text" value="<%= (@params["company"]["name"] || @company["name"]) %>" required>
                </div>
                <div class="form-group <%= if @errors["company"]["vat"] do %>has-error<% end %>">
                  <label for="company_vat">VAT number</label>
                  <input id="company_vat" name="company[vat]" class="form-control" type="text" value="<%= (@params["company"]["vat"] || @company["vat"]) %>">
                  <%= if @errors["company"]["vat"] do %>
                    <span class="help-block"><%= @errors["company"]["vat"] %></span>
                  <% end %>
                </div>
                <div class="form-group">
                  <label for="company_address_line1">Address</label>
                  <div class="row">
                    <div class="col-xs-6">
                      <input id="company_address_line1" name="company[address_line1]" class="form-control" type="text" value="<%= (@params["company"]["address_line1"] || @company["address_line1"]) %>" required>
                    </div>
                    <div class="col-xs-6">
                      <input id="company_address_line2" name="company[address_line2]" class="form-control" type="text" value="<%= (@params["company"]["address_line2"] || @company["address_line2"]) %>">
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="company_address_zip">Zip code</label>
                  <input id="company_address_zip" name="company[address_zip]" class="form-control" type="text" value="<%= (@params["company"]["address_zip"] || @company["address_zip"]) %>" required>
                </div>
                <div class="form-group">
                  <label for="company_address_city">City</label>
                  <input id="company_address_city" name="company[address_city]" class="form-control" type="text" value="<%= (@params["company"]["address_city"] || @company["address_city"]) %>" required>
                </div>
                <div class="form-group">
                  <label for="company_address_state">State</label>
                  <input id="company_address_state" name="company[address_state]" class="form-control" type="text" value="<%= (@params["company"]["address_state"] || @company["address_state"]) %>">
                </div>
                <div class="form-group">
                  <label for="company_address_country">Country</label>
                  <select id="company_address_country" name="company[address_country]" class="form-control" required>
                    <%= for {code, country} <- countries() do %>
                      <option value="<%= code %>" <%= if code ==  (@params["company"]["address_country"] || @company["address_country"]) do %>selected<% end %>><%= country %></option>
                    <% end %>
                  </select>
                </div>
                <%= submit "Save", class: "btn btn-primary" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <%= if @invoices != [] do %>
        <div class="panel-body-part">
          <h4>Payment history</h4>
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Payment</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <%= for invoice <- @invoices do %>
                <tr>
                  <td>
                    <a href="<%= Routes.dashboard_path(Endpoint, :show_invoice, @repository, invoice["id"]) %>" target="_blank">
                      <%= payment_date(invoice["date"]) %>
                    </a>
                    </td>
                  <td>$<%= money(invoice["amount_due"])%></td>
                  <td><%= payment_card(invoice["card"]) %></td>
                  <td><%= invoice_status(invoice) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>

  <div class="col-md-9 repository">
    <div class="panel panel-danger">
      <div class="panel-heading">Danger zone</div>
      <div class="panel-body">
        <p><em>Leave, delete (delete == inactive) organization...</em></p>
      </div>
    </div>
  </div>
</div>
